<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categorías</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta name="_csrf" th:content="${_csrf.token}">
</head>
<body class="flex h-screen bg-gray-100">

<!-- Sidebar -->
<div th:replace="fragments/sidebar :: sidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-10"></div>

<!-- Contenido principal -->
<main class="flex-1 lg:pl-72 p-6 space-y-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Categorías</h1>
        <div class="flex items-center space-x-4">
            <form method="GET" action="" class="flex items-center space-x-4">
                <input type="text" name="buscar" placeholder="Buscar..."
                       class="border border-gray-300 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-red-600">
            </form>
            <button onclick="abrirModal(null)"
                    class="bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700 shadow-md transition duration-300">
                AGREGAR
            </button>
        </div>
    </div>

    <!-- Contenedor de categorías -->
    <div th:if="${!#lists.isEmpty(categorias)}"
         class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div th:each="categoria : ${categorias}"
             class="bg-white p-6 rounded-3xl shadow-xl hover:shadow-2xl transition-shadow duration-300 relative">

            <h2 class="text-xl font-semibold text-red-800 mb-4" th:text="${categoria.nombre}"></h2>
            <p class="text-gray-700 mb-1">Descripción: <span th:text="${categoria.descripcion}"></span></p>
            <p class="text-gray-700 mb-1">Código: <span th:text="${categoria.codigo}"></span></p>
            <p class="text-gray-700 mb-3">Tipo: <span th:text="${categoria.tipo}"></span></p>

            <!-- Botones -->
            <div class="flex justify-end space-x-2 mt-3">
                <button type="button"
                        th:onclick="'abrirModal(' + ${categoria.id} + ')'"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md transition duration-200">
                    Editar
                </button>
                <button type="button"
                        th:onclick="'eliminarCategoria(' + ${categoria.id} + ')'"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl shadow-md transition duration-200">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <!-- Mensaje si no hay categorías -->
    <div th:if="${#lists.isEmpty(categorias)}"
         class="text-center text-gray-500 mt-12 text-lg sm:text-xl">
        Aún no hay categorías
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const swalInputClass = 'swal2-input block w-full max-w-xs px-4 py-2 border border-gray-300 rounded-xl shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200 mx-auto';

        // FUNCION UNIFICADA AGREGAR / EDITAR
        window.abrirModal = function(id) {
            let urlFetch = id ? `/user/categorias/editar/${id}` : null;

            if (id) {
                // Editar: obtener datos
                fetch(urlFetch)
                    .then(res => res.json())
                    .then(data => abrirSwal(data))
                    .catch(() => Swal.fire('Error','No se pudo obtener los datos de la categoría','error'));
            } else {
                abrirSwal({ nombre: '', descripcion: '', codigo: '', tipo: '' });
            }

            function abrirSwal(data) {
                Swal.fire({
                    title: id ? 'Editar Categoría' : 'Agregar Categoría',
                    html: `
                    <input id="nombre" class="${swalInputClass}" placeholder="Nombre" value="${data.nombre}">
                    <input id="descripcion" class="${swalInputClass}" placeholder="Descripción" value="${data.descripcion}">
                    <input id="codigo" class="${swalInputClass}" placeholder="Código" value="${data.codigo}">
                    <input id="tipo" class="${swalInputClass}" placeholder="Tipo" value="${data.tipo}">
                `,
                    confirmButtonText: id ? 'Actualizar' : 'Agregar',
                    confirmButtonColor: '#dc2626',
                    focusConfirm: false,
                    preConfirm: () => {
                        const nombre = Swal.getPopup().querySelector('#nombre').value;
                        const descripcion = Swal.getPopup().querySelector('#descripcion').value;
                        const codigo = Swal.getPopup().querySelector('#codigo').value;
                        const tipo = Swal.getPopup().querySelector('#tipo').value;
                        if(!nombre || !descripcion || !codigo || !tipo) Swal.showValidationMessage("Complete todos los campos");
                        return { nombre, descripcion, codigo, tipo };
                    }
                }).then(result => {
                    if(result.isConfirmed){
                        const formData = new FormData();
                        formData.append('nombre', result.value.nombre);
                        formData.append('descripcion', result.value.descripcion);
                        formData.append('codigo', result.value.codigo);
                        formData.append('tipo', result.value.tipo);

                        let url = id ? `/user/categorias/editar/${id}` : `/user/categorias/guardar`;

                        fetch(url, { method: 'POST', headers: { 'X-CSRF-TOKEN': csrfToken }, body: formData })
                            .then(res => res.ok ? res.text() : Promise.reject())
                            .then(() => Swal.fire('Éxito', id ? 'Categoría actualizada' : 'Categoría agregada', 'success').then(()=>location.reload()))
                            .catch(() => Swal.fire('Error','No se pudo guardar la categoría','error'));
                    }
                });
            }
        }

        // ELIMINAR CATEGORÍA
        window.eliminarCategoria = function(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if(result.isConfirmed){
                    fetch(`/user/categorias/eliminar/${id}`, {
                        method: 'POST',
                        headers: { 'X-CSRF-TOKEN': csrfToken }
                    })
                        .then(res => res.ok ? res.text() : Promise.reject())
                        .then(() => Swal.fire('Eliminado!', 'La categoría ha sido eliminada.', 'success').then(()=>location.reload()))
                        .catch(() => Swal.fire('Error','No se pudo eliminar la categoría','error'));
                }
            });
        }
    });
</script>

</body>
</html>
