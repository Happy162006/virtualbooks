<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categorías</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta name="csrf-token" th:content="${_csrf.token}">
</head>
<body class="bg-gray-100">

<!-- Sidebar fijo -->
<div th:replace="fragments/sidebar :: sidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-10"></div>

<!-- Contenido principal -->
<div class="ml-64 p-6 space-y-8">
    <!-- Encabezado y botón agregar -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Categorías</h1>
        <button onclick="abrirModalAgregar()"
                class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition">
            Agregar
        </button>
    </div>

    <!-- Listado de categorías -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div th:each="categoria : ${categorias}"
             class="bg-white p-6 rounded-lg shadow-md relative hover:shadow-lg transition">
            <h3 class="text-xl font-semibold text-red-800 mb-2" th:text="${categoria.nombre}"></h3>
            <p class="text-gray-700 mb-1">Descripción: <span th:text="${categoria.descripcion}"></span></p>
            <p class="text-gray-700 mb-1">Código: <span th:text="${categoria.codigo}"></span></p>
            <p class="text-gray-700 mb-3">Tipo: <span th:text="${categoria.tipo}"></span></p>

            <!-- Botones -->
            <div class="absolute bottom-3 right-3 flex space-x-2">
                <button type="button"
                        th:onclick="'abrirModalEditar(' + ${categoria.id} + ')' "
                        class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Editar</button>
                <button type="button"
                        th:onclick="'eliminarCategoria(' + ${categoria.id} + ')' "
                        class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>
</div>




<!-- Modal agregar/editar -->
<div id="modalCategoria" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white p-8 rounded-xl w-full max-w-md relative">
        <h2 id="modalTitle" class="text-2xl font-bold mb-4">Agregar Categoría</h2>
        <form id="formCategoria" th:action="@{/user/categorias/guardar}" method="post">
            <input type="hidden" name="_csrf" th:value="${_csrf.token}">
            <input type="hidden" name="id" id="categoriaId">

            <div class="mb-4">
                <label class="font-semibold block mb-1">Nombre</label>
                <input type="text" id="nombre" name="nombre" required
                       class="w-full px-4 py-2 border rounded">
            </div>

            <div class="mb-4">
                <label class="font-semibold block mb-1">Descripción</label>
                <textarea id="descripcion" name="descripcion"
                          class="w-full px-4 py-2 border rounded"></textarea>
            </div>

            <div class="mb-4">
                <label class="font-semibold block mb-1">Código</label>
                <input type="text" id="codigo" name="codigo"
                       class="w-full px-4 py-2 border rounded">
            </div>

            <div class="mb-4">
                <label class="font-semibold block mb-1">Tipo</label>
                <input type="text" id="tipo" name="tipo"
                       class="w-full px-4 py-2 border rounded">
            </div>

            <div class="flex justify-end space-x-4 mt-4">
                <button type="button" onclick="cerrarModal()"
                        class="px-4 py-2 rounded bg-gray-400 hover:bg-gray-500 text-white">Cancelar</button>
                <button type="submit"
                        class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white">Guardar</button>
            </div>
        </form>
    </div>
</div>

<script>
    const modal = document.getElementById('modalCategoria');
    const modalTitle = document.getElementById('modalTitle');

    function abrirModalAgregar() {
        modalTitle.innerText = 'Agregar Categoría';
        document.getElementById('formCategoria').reset();
        document.getElementById('categoriaId').value = '';
        modal.classList.remove('hidden');
    }

    function abrirModalEditar(id) {
        fetch(`/user/categorias/editar/${id}`)
            .then(res => res.json())
            .then(data => {
                modalTitle.innerText = 'Editar Categoría';
                document.getElementById('categoriaId').value = data.id;
                document.getElementById('nombre').value = data.nombre;
                document.getElementById('descripcion').value = data.descripcion;
                document.getElementById('codigo').value = data.codigo;
                document.getElementById('tipo').value = data.tipo;
                modal.classList.remove('hidden');
            });
    }

    function cerrarModal() {
        modal.classList.add('hidden');
    }

    function eliminarCategoria(id) {
        Swal.fire({
            title: '¿Estás seguro?',
            text: "No podrás revertir esto",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/user/categorias/eliminar/${id}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    }
                }).then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Eliminado!',
                        text: 'Categoría eliminada correctamente',
                        position: 'center',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => location.reload());
                });
            }
        });
    }

    // Mostrar alerta de éxito después de guardar
    window.addEventListener('DOMContentLoaded', () => {
        const successMessage = /*[[${success}]]*/ 'null';
        if (successMessage && successMessage !== 'null') {
            Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: successMessage,
                position: 'center',
                showConfirmButton: false,
                timer: 1500
            });
        }
    });
</script>

</body>
</html>
